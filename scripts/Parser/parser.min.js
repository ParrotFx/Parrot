var __extends=this.__extends||function(n,t){function i(){this.constructor=n}i.prototype=t.prototype,n.prototype=new i},ParrotDocument=function(){function n(){this.errors=[],this.children=[]}return n}(),Parser=function(){function n(){this.errors=[]}return n.prototype.parse=function(n){var t=new ParrotDocument,i=new Tokenizer(n),r=i.tokens(),u=new Stream(r),f=this;return this.parseStream(u,function(n){for(var i in n)f.parseStatementErrors(n[i]),t.children.push(n[i])}),t.errors=this.errors,console.log(t.children),t},n.prototype.parseStatementErrors=function(n){var i,t;if(n.errors.length>0)for(i in n.errors)t=n.errors[i],t.index+=n.index,this.errors.push(t)},n.prototype.parseStream=function(n,t){for(var i,r;n.peek()!=null;){i=n.peek();switch(i.type){case TokenType.stringLiteral:case TokenType.stringLiteralPipe:case TokenType.quotedStringLiteral:case TokenType.identifier:case TokenType.openBracket:case TokenType.openParenthesis:case TokenType.equal:case TokenType.at:r=this.parseStatement(n),t(r);break;default:this.errors.push(new UnexpectedToken(i)),n.next()}}},n.prototype.parseStatement=function(n){var r=n.peek(),s,t,h,i,f,e,u,o,c;if(r==null)return this.errors.push(new EndOfStream),[];s=r.type,t=null;switch(s){case TokenType.identifier:t=n.next();break;case TokenType.openBracket:case TokenType.openParenthesis:break;case TokenType.stringLiteral:case TokenType.stringLiteralPipe:case TokenType.quotedStringLiteral:t=n.next();break;case TokenType.at:n.nextNoReturn(),t=n.next();break;case TokenType.equal:n.nextNoReturn(),t=n.next();break;default:return this.errors.push(new UnexpectedToken(r)),[]}for(i=null,f=!1;n.peek()!=null&&!f;){if(e=n.peek(),e==null)break;switch(e.type){case TokenType.openParenthesis:case TokenType.openBracket:case TokenType.openBrace:i=this.parseStatementTail(n);break;case TokenType.greaterThan:n.nextNoReturn(),i=this.parseSingleStatementTail(n);break;default:this.getStatementFromToken(t,i,null),f=!0}}for(h=this.getStatementFromToken(t,i,r),u=[],u.push(h);n.peek()!=null;)if(n.peek().type==TokenType.plus){n.nextNoReturn(),o=this.parseStatement(n);for(c in o)u.push(o[c])}else break;return u},n.prototype.getStatementFromToken=function(n,t,i){var r=n!=null?n.content:"";if(n!=null)switch(n.type){case TokenType.stringLiteral:case TokenType.quotedStringLiteral:return new StringLiteral(r,t,n.index);case TokenType.stringLiteralPipe:return new StringLiteralPipe(r.substring(1),t,n.index)}if(i!=null)switch(i.type){case TokenType.at:return new EncodedOutput(r,null,i.index);case TokenType.equal:return new RawOutput(r,null,i.index)}return new Statement(r,t,n.index)},n.prototype.parseSingleStatementTail=function(n){var i=this.parseStatement(n),t=new StatementTail;return t.children=i,t},n.prototype.parseStatementTail=function(n){for(var t=new Array(3),r=!1,u,i;n.peek()!=null&&!r;){u=n.peek();switch(u.type){case TokenType.openParenthesis:t[1]=this.parseParameters(n);break;case TokenType.openBracket:t[0]=this.parseAttributes(n);break;case TokenType.greaterThan:t[2]=this.parseChild(n);break;case TokenType.openBrace:t[2]=this.parseChildren(n),r=!0;break;default:r=!0}}return i=new StatementTail,i.attributes=t[0],i.parameters=t[1],i.children=t[2],i},n.prototype.parseChild=function(n){var r=[],t,u,i,f;for(n.nextNoReturn(),t=!1;n.peek()!=null&&!t;){if(u=n.peek(),u==null)break;i=this.parseStatement(n);for(f in i)r.push(i[f]);t=!0}return r},n.prototype.parseChildren=function(n){var i=[],r,u,t,f;for(n.nextNoReturn(),r=!1;n.peek()!=null&&!r;){if(u=n.peek(),u==null)break;switch(u.type){case TokenType.plus:break;case TokenType.closeBrace:n.nextNoReturn(),r=!0;break;default:t=this.parseStatement(n),console.log("parseChildren:",t);for(f in t)i.push(t[f])}}return console.log("returning:",i),i},n.prototype.parseParameters=function(n){var i=[],r,t;for(n.nextNoReturn(),r=!1;n.peek()!=null&&!r;){if(t=n.peek(),t==null)break;switch(t.type){case TokenType.identifier:case TokenType.quotedStringLiteral:case TokenType.stringLiteralPipe:i.push(this.parseParameter(n));break;case TokenType.comma:n.nextNoReturn();break;case TokenType.closeParenthesis:n.nextNoReturn(),r=!0;break;default:return this.errors.push(new UnexpectedToken(t)),i}}return i},n.prototype.parseParameter=function(n){var t=n.next();switch(t.type){case TokenType.stringLiteralPipe:case TokenType.quotedStringLiteral:case TokenType.stringLiteral:case TokenType.identifier:break;default:return this.errors.push(new UnexpectedToken(t)),null}return new Parameter(t.content)},n.prototype.parseAttributes=function(n){for(var i=[],t=null,r=!1;n.peek()!=null&&!r;){if(t=n.peek(),t==null)break;switch(t.type){case TokenType.identifier:i.push(this.parseAttribute(n));break;case TokenType.closeBracket:n.nextNoReturn(),r=!0;break;default:return this.errors.push(new AttributeIdentifierMissing(t.index)),i}}},n.prototype.parseAttribute=function(n){var i=n.next(),u=n.peek(),r,t;if(u!=null&&u.type==TokenType.equal){if(n.nextNoReturn(),r=n.peek(),r==null)return this.errors.push(new UnexpectedToken(i)),new Attribute(i.content,null);if(r.type==TokenType.closeBracket&&this.errors.push(new AttributeValueMissing(r.index)),t=this.parseStatement(n)[0],t!=null)switch(t.name){case"true":case"false":case"null":t=new StringLiteral('"'+t.name+'"',null,0)}return new Attribute(i.content,t)}return new Attribute(i.content,null)},n}(),AttributeValueMissing=function(n){function t(t){n.call(this),this.index=t,this.message="Attribute must have a value"}return __extends(t,n),t}(ParserError),AttributeIdentifierMissing=function(n){function t(t){n.call(this),this.index=t,this.message="Invalid attribute name"}return __extends(t,n),t}(ParserError),EndOfStream=function(n){function t(){n.call(this),this.message="Unexpected end of file."}return __extends(t,n),t}(ParserError),UnexpectedToken=function(n){function t(t){n.call(this),this.type=t.type,this.token=t.content,this.index=t.index,this.message="Unexpected token: "+this.type}return __extends(t,n),t}(ParserError),Statement=function(){function n(n,t,i){this.index=i,this.parameters=[],this.attributes=[],this.children=[],this.identifierParts=[],this.errors=[];var r=this;this.indexOfAny(n,[".","#",":"])>-1?this.getIdentifierParts(n,function(n){var t;switch(n.type){case IdentifierType.id:n.name.length==0?r.errors.push(new MissingIdDeclaration(n.index-1,1)):r.anyAttributes(function(n){return n.key=="id"})?r.errors.push(new MultipleIdDeclarations(n.name,n.index-1,n.name.length+1)):(t=new StringLiteral('"'+n.name+'"',null,0),r.addAttribute(new Attribute("id",t)));break;case IdentifierType.class:n.name.length==0?r.errors.push(new MissingClassDeclaration(1,1)):(t=new StringLiteral('"'+n.name+'"',null,0),r.addAttribute(new Attribute("class",t)));break;case IdentifierType.type:t=new StringLiteral('"'+n.name+'"',null,0),r.addAttribute(new Attribute("type",t));break;case IdentifierType.literal:r.name=n.name}r.identifierParts.push(n)}):r.name=n,this.parseStatementTail(t)}return n.prototype.anyAttributes=function(n){for(var t in this.attributes)if(n(this.attributes[t]))return!0;return!1},n.prototype.parseStatementTail=function(n){if(n!=null){if(n.parameters!=null&&(this.parameters=n.parameters),n.attributes!=null){for(var t in this.attributes)n.attributes.push(this.attributes[t]);this.attributes=n.attributes}n.children!=null&&(this.children=n.children)}},n.prototype.addAttribute=function(n){this.attributes.push(n)},n.prototype.identifierTypeFromCharacter=function(n,t){switch(n){case":":return IdentifierType.type;case"#":return IdentifierType.id;case".":return IdentifierType.class}return t},n.prototype.getIdentifierParts=function(n,t){for(var r=0,e=IdentifierType.literal,f=IdentifierType.none,i,u=0;u<n.length;u++)f=this.identifierTypeFromCharacter(n.charAt(u),f),f!=IdentifierType.none&&(i=new Identifier,i.name=n.substring(r,r+(u-r)),i.type=e,i.index=r,i.length=u-r,t(i),r=u+1,e=f,f=IdentifierType.none);i=new Identifier,i.name=n.substring(r),i.type=e,i.index=r,t(i)},n.prototype.indexOfAny=function(n,t){var r,i;for(r in t)if(i=n.indexOf(t[r]),i!=-1)return i;return-1},n}(),MissingIdDeclaration=function(n){function t(t,i){n.call(this),this.index=t,this.length=i,this.message="Missing Id declaration"}return __extends(t,n),t}(ParserError),MissingClassDeclaration=function(n){function t(t,i){n.call(this),this.index=t,this.length=i,this.message="Missing Class declaration"}return __extends(t,n),t}(ParserError),MultipleIdDeclarations=function(n){function t(t,i,r){n.call(this),this.id=t,this.index=i,this.length=r,this.message="Element may not have more than one id"}return __extends(t,n),t}(ParserError),Parameter=function(){function n(n){this.value=n}return n}(),StatementTail=function(){function n(){}return n}(),Attribute=function(){function n(n,t){this.key=n,this.value=t}return n}(),Identifier=function(){function n(){}return n}(),IdentifierType,ValueType,StringLiteralPartType;(function(n){n._map=[],n._map[0]="id",n.id=0,n._map[1]="class",n.class=1,n._map[2]="literal",n.literal=2,n._map[3]="type",n.type=3,n._map[4]="none",n.none=4})(IdentifierType||(IdentifierType={})),function(n){n._map=[],n._map[0]="stringLiteral",n.stringLiteral=0,n._map[1]="property",n.property=1,n._map[2]="local",n.local=2,n._map[3]="keyword",n.keyword=3}(ValueType||(ValueType={})),function(n){n._map=[],n._map[0]="literal",n.literal=0,n._map[1]="encoded",n.encoded=1,n._map[2]="raw",n.raw=2}(StringLiteralPartType||(StringLiteralPartType={}));var StringLiteralPart=function(){function n(n,t,i){this.type=n,this.data=t,this.index=i,this.length=t.length}return n}(),StringLiteral=function(n){function t(t,i,r){n.call(this,"string",i,r),this.values=[],this.valueType=ValueType.stringLiteral,this.isWrappedInQuotes(t)?(this.valueType=ValueType.stringLiteral,t=t.substring(1,1+t.length-2)):this.valueType=t=="this"?ValueType.local:t=="null"||t=="true"||t=="false"?ValueType.keyword:ValueType.property,this.valueType==ValueType.stringLiteral&&(this.values=this.parse(t))}return __extends(t,n),t.prototype.startsWith=function(n,t){return n.length>0&&n.charAt(0)==t},t.prototype.isWrappedInQuotes=function(n){return this.startsWith(n,'"')||this.startsWith(n,"'")},t.prototype.parse=function(n){for(var f=[],i=0,u=new Array(n.length),e,o,r,t=0;t<n.length;t++)if(n.charAt(t)=="@"||n.charAt(t)=="=")if(e=n.charAt(t),o=e=="@"?StringLiteralPartType.encoded:StringLiteralPartType.raw,t++,n.charAt(Math.min(n.length-1,t))==e)u[i++]=e;else if(this.isIdentifierHead(n.charAt(t))){for(i>0&&f.push(new StringLiteralPart(StringLiteralPartType.literal,u.join(""),t-i)),i=0,r="";t<n.length;t++,i++){if(!this.isIdTail(n.charAt(t)))break;r+=n.charAt(t)}r.charAt(r.length-1)=="."?(r=r.substring(0,r.length-1),f.push(new StringLiteralPart(o,r,t-i)),i=0,u[i++]="."):(f.push(new StringLiteralPart(o,r,t-i)),i=0),t<n.length&&(u[i++]=n.charAt(t))}else u[i++]=e,t-=1;else u[i++]=n.charAt(t);return i>0&&f.push(new StringLiteralPart(StringLiteralPartType.literal,u.join(""),n.length-i)),f},t.prototype.isIdentifierHead=function(n){return n.match(/[a-zA-Z]/)||n=="_"||n=="#"||n=="."},t.prototype.isIdTail=function(n){return n.match(/[0-9]/)||this.isIdentifierHead(n)||n==":"||n=="-"},t}(Statement),StringLiteralPipe=function(n){function t(t,i,r){n.call(this,t,i,r)}return __extends(t,n),t}(StringLiteral),EncodedOutput=function(n){function t(t,i,r){n.call(this,'"@'+t+'"',i,r)}return __extends(t,n),t}(StringLiteral),RawOutput=function(n){function t(t,i,r){n.call(this,'"='+t+'"',i,r)}return __extends(t,n),t}(StringLiteral)